---

- yum: name={{ item }}
  with_items:
    - epel-release

- yum: name={{ item }}
  with_items:
    - httpd
    - munin
    - munin-cgi
    - net-snmp-utils

- copy: src=./{{ item }} dest=/{{ item }}
  with_items:
    - /etc/munin/munin.conf
    - /etc/munin/munin-node.conf
    - /etc/munin/conf.d/example.conf
    - /etc/munin/plugin-conf.d/zzz-snmp
  notify:
    - munin-node restart

- service: name=munin-node state=started enabled=yes

- name: munin-node check
  shell: echo "fetch load" | nc localhost 4949
  changed_when: no

- stat: path=/etc/munin/munin-htpasswd
  register: res
  changed_when: res.stat.size == 0

- name: munin-htpasswd generate
  shell: htpasswd -bc /etc/munin/munin-htpasswd munin pass
  when: res|changed

- name: munin snmp plugin check
  shell: |
    munin-node-configure --snmp 192.168.33.10 --snmpcommunity oreore --shell
  register: res
  always_run: yes
  changed_when: res.stdout|length

- name: munin snmp plugin install
  shell: |
    munin-node-configure --snmp 192.168.33.10 --snmpcommunity oreore --shell | bash -x
  when: res|changed

- stat: path=/etc/munin/munstrap/templates/
  register: res
  changed_when: not res.stat.exists

- name: download munin-contrib munstrap
  shell: |
    set -eux
    rm -fr /tmp/munin-contrib
    mkdir -p /tmp/munin-contrib
    mkdir -p /etc/munin/munstrap
    wget https://github.com/munin-monitoring/contrib/archive/master.tar.gz -O - |
      tar xzf - -C /tmp/munin-contrib --strip-components=1
    rm -fr /var/www/html/munin/static
    rsync -av /tmp/munin-contrib/templates/munstrap/static/    /etc/munin/munstrap/static/
    rsync -av /tmp/munin-contrib/templates/munstrap/templates/ /etc/munin/munstrap/templates/
    rm -fr /tmp/munin-contrib
  when: res|changed

- service: name=httpd state=started enabled=yes
